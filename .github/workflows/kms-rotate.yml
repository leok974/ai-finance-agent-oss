name: KMS - Monthly Key Rotation

on:
  # Run on the 1st of every month at 09:00 UTC
  schedule:
    - cron: "0 9 1 * *"

  # Allow manual trigger with dry-run option
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (true/false) - skip actual rotation"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      rotation_type:
        description: "Rotation type"
        required: false
        default: "new-dek"
        type: choice
        options:
          - "new-dek"
          - "rewrap-kek"

permissions:
  contents: read
  id-token: write  # For OIDC authentication if needed

env:
  BASE_URL: https://api.ledger-mind.org

jobs:
  rotate:
    name: Rotate Active DEK (KMS)
    runs-on: ubuntu-latest  # Change to [self-hosted, prod] if using self-hosted runner
    timeout-minutes: 15

    # Require manual approval for production changes
    environment:
      name: production
      url: https://app.ledger-mind.org

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Pre-rotation smoke test
        id: pre_check
        run: |
          echo "ðŸ” Running pre-rotation health check..."
          python scripts/smoke-crypto-kms.py --base-url "$BASE_URL" --verbose
          echo "âœ… Pre-rotation health check passed"

      - name: Backup encryption_keys metadata
        id: backup
        run: |
          echo "ðŸ’¾ Creating backup of encryption keys metadata..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="encryption_keys_snapshot_${TIMESTAMP}.csv"

          # Note: This requires SSH access or self-hosted runner with Docker access
          # For GitHub-hosted runners, you would need to expose a secure backup endpoint
          echo "Backup file would be: ${BACKUP_FILE}"
          echo "backup_file=${BACKUP_FILE}" >> $GITHUB_OUTPUT

          # Example for self-hosted runner:
          # docker exec ai-finance-postgres-1 psql -U myuser -d finance \
          #   -c "COPY (SELECT id,label,kms_key_id,created_at FROM encryption_keys ORDER BY created_at) TO STDOUT WITH CSV HEADER" \
          #   > "${BACKUP_FILE}"

          # For GitHub-hosted runners, use an API endpoint:
          # curl -X POST "$BASE_URL/admin/backup/encryption-keys" \
          #   -H "Authorization: Bearer ${ADMIN_TOKEN}" \
          #   -o "${BACKUP_FILE}"

          echo "âš ï¸ MANUAL STEP: For GitHub-hosted runners, implement secure backup endpoint"
          echo "âœ… Backup step configured (requires implementation based on runner type)"

      - name: Check dry-run mode
        id: check_dry_run
        run: |
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ§ª DRY RUN MODE - Skipping actual rotation"
            echo "dry_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "dry_run=false" >> $GITHUB_OUTPUT

      - name: Rotate DEK (Generate new active; KMS-wrapped)
        if: steps.check_dry_run.outputs.dry_run == 'false' && inputs.rotation_type == 'new-dek'
        id: rotate_dek
        run: |
          echo "ðŸ”„ Rotating DEK (generating new active key)..."

          # For self-hosted runner with Docker access:
          # docker exec ai-finance-backend-1 python -m app.cli force-new-active-dek

          # For GitHub-hosted runners, use an authenticated API endpoint:
          # curl -X POST "$BASE_URL/admin/crypto/rotate-dek" \
          #   -H "Authorization: Bearer ${ADMIN_TOKEN}" \
          #   -H "Content-Type: application/json"

          echo "âš ï¸ MANUAL STEP: Implement rotation endpoint for your runner type"
          echo "Options:"
          echo "  A. Use self-hosted runner: [self-hosted, prod] with Docker access"
          echo "  B. Create secure admin endpoint: POST /admin/crypto/rotate-dek"
          echo "  C. Use SSH action to connect to server"

          echo "âœ… Rotation command configured (requires implementation)"

      - name: Rewrap KEK (Alternative rotation type)
        if: steps.check_dry_run.outputs.dry_run == 'false' && inputs.rotation_type == 'rewrap-kek'
        id: rewrap_kek
        run: |
          echo "ðŸ”„ Rewrapping KEK with KMS..."

          # For self-hosted runner:
          # docker exec ai-finance-backend-1 python -m app.cli kek-rewrap-gcp

          # For GitHub-hosted runners:
          # curl -X POST "$BASE_URL/admin/crypto/rewrap-kek" \
          #   -H "Authorization: Bearer ${ADMIN_TOKEN}"

          echo "âš ï¸ MANUAL STEP: Implement KEK rewrap endpoint"
          echo "âœ… KEK rewrap configured (requires implementation)"

      - name: Wait for backend to stabilize
        if: steps.check_dry_run.outputs.dry_run == 'false'
        run: |
          echo "â³ Waiting for backend to stabilize after rotation..."
          sleep 15
          echo "âœ… Wait complete"

      - name: Restart backend (if needed)
        if: steps.check_dry_run.outputs.dry_run == 'false'
        id: restart
        run: |
          echo "ðŸ”„ Backend restart may be needed for some rotation types..."

          # For self-hosted runner:
          # docker compose -f docker-compose.yml restart backend

          # For GitHub-hosted runners with remote access:
          # curl -X POST "$BASE_URL/admin/backend/restart" \
          #   -H "Authorization: Bearer ${ADMIN_TOKEN}"

          echo "â„¹ï¸ Restart not always required - depends on rotation type"
          echo "âœ… Restart step configured"

      - name: Post-rotation health check
        if: always() && steps.check_dry_run.outputs.dry_run == 'false'
        id: post_check
        run: |
          echo "ðŸ” Running post-rotation health check..."

          # Wait for potential restart
          sleep 10

          # Retry health check up to 3 times
          for i in {1..3}; do
            echo "Attempt $i/3..."
            if python scripts/smoke-crypto-kms.py --base-url "$BASE_URL" --verbose; then
              echo "âœ… Post-rotation health check passed"
              exit 0
            fi
            if [[ $i -lt 3 ]]; then
              echo "â³ Waiting 10s before retry..."
              sleep 10
            fi
          done

          echo "âŒ Post-rotation health check failed after 3 attempts"
          exit 1

      - name: Verify crypto status
        if: steps.check_dry_run.outputs.dry_run == 'false'
        run: |
          echo "ðŸ“Š Fetching detailed crypto status..."
          curl -s "$BASE_URL/healthz" | jq '{crypto_mode, crypto_ready, status}'

      - name: Generate rotation summary
        if: always()
        run: |
          echo "# ðŸ” KMS Key Rotation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Rotation Type:** ${{ inputs.rotation_type || 'new-dek' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "## ðŸ§ª Dry Run Mode" >> $GITHUB_STEP_SUMMARY
            echo "No actual rotation performed. Pre-checks passed." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.post_check.outcome }}" == "success" ]]; then
            echo "## âœ… Rotation Successful" >> $GITHUB_STEP_SUMMARY
            echo "- Pre-rotation health: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- Backup created: ${{ steps.backup.outputs.backup_file }}" >> $GITHUB_STEP_SUMMARY
            echo "- Rotation executed: âœ… Complete" >> $GITHUB_STEP_SUMMARY
            echo "- Post-rotation health: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Monitor health: https://grafana.ledger-mind.org/d/kms-crypto-health" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify no alerts: Check AlertManager" >> $GITHUB_STEP_SUMMARY
            echo "3. Archive backup: Store backup securely" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Rotation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Post-rotation health check failed. See logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recovery Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Check health endpoint: $BASE_URL/healthz" >> $GITHUB_STEP_SUMMARY
            echo "2. Review backend logs: \`docker logs ai-finance-backend-1\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Follow runbook: [KMS_OPERATIONS.md](../docs/KMS_OPERATIONS.md)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::KMS key rotation failed"
          echo "::error::Check health endpoint: $BASE_URL/healthz"
          echo "::error::Review logs and follow runbook: docs/KMS_OPERATIONS.md"

# Implementation Notes:
#
# This workflow is configured for GitHub-hosted runners by default.
# For production use, choose one of these implementation paths:
#
# Option A: Self-Hosted Runner (Recommended for simplicity)
#   1. Set up a self-hosted runner on your production server
#   2. Change `runs-on` to: [self-hosted, prod]
#   3. Uncomment Docker commands in steps above
#   4. Runner will have direct Docker access
#
# Option B: Secure Admin Endpoints (Recommended for security)
#   1. Create admin API endpoints for rotation operations:
#      - POST /admin/crypto/rotate-dek (with auth)
#      - POST /admin/crypto/rewrap-kek (with auth)
#      - POST /admin/backup/encryption-keys (with auth)
#   2. Use GitHub Secrets to store admin token
#   3. Update curl commands in steps to use endpoints
#
# Option C: SSH Action (Alternative)
#   1. Use appleboy/ssh-action@master
#   2. Store SSH credentials in GitHub Secrets
#   3. Execute Docker commands remotely via SSH
#
# Security Considerations:
#   - Always use environment protection with required reviewers
#   - Store sensitive credentials in GitHub Secrets
#   - Audit all rotation events
#   - Maintain backup retention policy
