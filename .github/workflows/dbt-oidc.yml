name: dbt (OIDC - No Static Keys)

on:
  schedule:
    # Run at 3 AM UTC daily
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC
  contents: read

env:
  DBT_PROJECT_DIR: ./warehouse

jobs:
  dbt-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via OIDC
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: dbt-runner@ledgermind-ml-analytics.iam.gserviceaccount.com
          token_format: access_token
          access_token_lifetime: 3600s

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify authentication
        run: |
          echo "âœ… Authenticated as:"
          gcloud auth list
          echo "ðŸ“Š Testing BigQuery access:"
          bq ls --project_id=ledgermind-ml-analytics || echo "âš ï¸  BigQuery access verification failed (expected if permissions not yet granted)"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt
        run: |
          pip install dbt-core dbt-bigquery==1.7.0

      - name: Install dbt dependencies
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: |
          dbt deps

      - name: Create dbt profiles.yml (OIDC-based)
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOF
          ledgermind:
            target: prod
            outputs:
              prod:
                type: bigquery
                method: oauth
                project: ledgermind-ml-analytics
                dataset: ${{ secrets.DBT_BIGQUERY_DATASET || 'dbt_prod' }}
                location: US
                threads: 4
                timeout_seconds: 300
                # Uses gcloud auth (OIDC token) - no keyfile needed
          EOF
          echo "âœ… dbt profile created (OIDC-based, no static keys)"

      - name: dbt debug (connection test)
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: |
          dbt debug --target prod

      - name: dbt run
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: |
          dbt run --target prod

      - name: dbt test
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: |
          dbt test --target prod

      - name: Generate documentation
        if: success()
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: |
          dbt docs generate --target prod

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: warehouse/target/*

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ dbt build failed. Check logs for details."
          # Add Slack/PagerDuty notification here if desired
