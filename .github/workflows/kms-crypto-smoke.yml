name: KMS Crypto Smoke Test

on:
  # Run on schedule (every 30 minutes)
  schedule:
    - cron: "*/30 * * * *"

  # Run on push to main
  push:
    branches: [ main ]

  # Run on pull requests that modify KMS-related files
  pull_request:
    branches: [ main ]
    paths:
      - 'apps/backend/app/crypto/**'
      - 'docker-compose*.yml'
      - 'scripts/smoke-crypto-kms.*'
      - '.github/workflows/kms-crypto-smoke.yml'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Base URL to test (default: https://api.ledger-mind.org)'
        required: false
        default: 'https://api.ledger-mind.org'

jobs:
  kms-smoke-production:
    name: KMS Crypto Health Check (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run KMS Crypto Smoke Test
        env:
          BASE_URL: ${{ github.event.inputs.base_url || 'https://api.ledger-mind.org' }}
        run: |
          python scripts/smoke-crypto-kms.py --base-url "$BASE_URL" --verbose

      - name: Notify on failure
        if: failure() && github.event_name == 'schedule'
        run: |
          echo "::error::KMS crypto health check failed on scheduled run"
          echo "::warning::Check https://api.ledger-mind.org/healthz manually"
          echo "::warning::Expected: crypto_mode=kms, crypto_ready=true"

  kms-smoke-local:
    name: KMS Crypto Health Check (Local Stack)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Launch minimal stack
        run: |
          # Launch backend, postgres, nginx
          docker compose -f docker-compose.yml up -d --quiet-pull backend postgres nginx

          # Wait for health
          echo "Waiting for backend to be ready..."
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8000/ready || true)
            if [ "$code" = "200" ]; then
              echo "Backend ready"
              break
            fi
            sleep 2
          done

          # Give crypto initialization time
          sleep 5

      - name: Run KMS Crypto Smoke Test (Local)
        run: |
          python scripts/smoke-crypto-kms.py --base-url "http://127.0.0.1:8000" --verbose
        continue-on-error: true
        id: kms_smoke

      - name: Show backend logs on failure
        if: steps.kms_smoke.outcome == 'failure'
        run: |
          echo "=== Backend Logs (last 50 lines) ==="
          docker compose logs --tail=50 backend
          echo ""
          echo "=== Health Check ==="
          curl -s http://127.0.0.1:8000/healthz | jq . || curl -s http://127.0.0.1:8000/healthz

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v

      - name: Fail if smoke test failed
        if: steps.kms_smoke.outcome == 'failure'
        run: |
          echo "::error::KMS crypto smoke test failed"
          exit 1
