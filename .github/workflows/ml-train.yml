name: ml-train

on:
  workflow_dispatch: {}
  schedule:
    # Run Mondays at 04:21 UTC
    - cron: "21 4 * * 1"

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install -r apps/backend/requirements.txt
          pip install lightgbm joblib pandas scikit-learn
      
      - name: Create artifacts directory
        run: mkdir -p apps/backend/artifacts
      
      - name: Train model
        working-directory: apps/backend
        env:
          SUGGEST_MODEL_DIR: ./artifacts
          DATABASE_URL: "sqlite:///./test.db"
        run: |
          python -m app.ml.train_lightgbm --out-dir ./artifacts > meta.json || echo "{}" > meta.json
          ls -la artifacts/ || true
      
      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: lm-model-${{ github.run_number }}
          path: apps/backend/artifacts/*
          retention-days: 30
      
      - name: Print training metadata
        run: |
          echo "Training metadata:"
          cat apps/backend/meta.json || echo "No metadata generated"
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let meta = {};
            try {
              meta = JSON.parse(fs.readFileSync('apps/backend/meta.json', 'utf8'));
            } catch {}
            
            const body = `## ðŸ¤– ML Model Training Complete
            
            **Run:** #${{ github.run_number }}
            **Model ID:** ${meta.model_id || 'N/A'}
            **Samples:** ${meta.n_samples || 'N/A'}
            **Classes:** ${meta.n_classes || 'N/A'}
            
            Download artifact from [Actions run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### Manual Promotion Steps
            
            1. Download artifact: \`lm-model-${{ github.run_number }}\`
            2. Copy to server: \`docker cp model.joblib backend:/app/data/models/\`
            3. Enable shadow mode: \`SUGGEST_SHADOW=true SUGGEST_MODEL_PATH=/app/data/models/model.joblib\`
            4. Monitor metrics for 24h
            5. If stable, set \`SUGGEST_MODE=auto\` + \`SUGGEST_CANARY_PCT=10\`
            `;
            
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
            }
