name: Prometheus Rules Update (Manual)

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  rules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure rules directory
        run: mkdir -p prometheus/rules

      - name: Write CSP edge recording rules
        shell: bash
        run: |
          cat > prometheus/rules/csp.yml <<'YAML'
          groups:
          - name: csp_edge
            rules:
            - record: edge_csp_policy_sha_current
              expr: max by (sha) (edge_csp_policy_sha == 1)
            - record: edge_csp_policy_length_current
              expr: max(edge_csp_policy_length)
            - record: edge_metrics_last_push_seconds
              expr: max(edge_metrics_timestamp_seconds)
          YAML

      - name: Write CSP alerting rules
        shell: bash
        run: |
          cat > prometheus/rules/csp_alerts.yml <<'YAML'
          groups:
          - name: csp_alerts
            rules:
            - alert: CSPNoRecentEdgePush
              expr: time() - edge_metrics_last_push_seconds > 1800
              for: 10m
              labels: { severity: warning }
              annotations:
                summary: "No edge metrics push in 30m"
                description: "Probe may be stalled or endpoint failing."
            - alert: CSPPolicyChanged
              expr: changes(edge_csp_policy_sha_current[1h]) > 0
              for: 0m
              labels: { severity: info }
              annotations:
                summary: "CSP policy hash changed in last hour"
                description: "Confirm intentional change vs drift."
            - alert: CSPCurrentShaInvariantBroken
              expr: count(edge_csp_policy_sha == 1) != 1
              for: 5m
              labels: { severity: critical }
              annotations:
                summary: "Edge CSP SHA invariant broken"
                description: "There should be exactly one active hash series at any time."
          YAML

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "feat(prometheus): add CSP edge recording rules and alerts"
          title: "feat(prometheus): add CSP edge recording rules and alerts"
          body: |
            Adds or updates:
            - prometheus/rules/csp.yml (edge_* recording rules)
            - prometheus/rules/csp_alerts.yml (alerts)

            Apply by reloading Prometheus with the updated rules path.
          labels: observability, security-review
          branch: chore/prom-rules-csp-${{ github.run_id }}
          delete-branch: true
