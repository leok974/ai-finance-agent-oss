name: DevDiag Quickcheck

"on":
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'apps/web/**'
      - 'apps/backend/**'
      - '.github/workflows/devdiag-quickcheck.yml'

jobs:
  quickcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: DevDiag Quickcheck (HTTP-only)
        env:
          DEVDIAG_BASE: ${{ secrets.DEVDIAG_BASE }}
          DEVDIAG_READER_JWT: ${{ secrets.DEVDIAG_READER_JWT }}
          TARGET_URL: ${{ secrets.LM_PREVIEW_URL }}
        run: |
          set -e

          echo "Running DevDiag quickcheck against: $TARGET_URL"

          response=$(curl -sS -X POST "$DEVDIAG_BASE/mcp/diag/quickcheck" \
            -H "Authorization: Bearer $DEVDIAG_READER_JWT" \
            -H "Content-Type: application/json" \
            -d "{\"url\":\"$TARGET_URL\",\"preset\":\"app\",\"tenant\":\"ledgermind\"}")

          echo "$response" | jq .

          # Check for critical failures
          critical_count=$(echo "$response" | jq '.problems | map(select(.severity == "critical")) | length')

          if [ "$critical_count" -gt 0 ]; then
            echo "::error::DevDiag found $critical_count critical issues"
            exit 1
          fi

          echo "âœ… DevDiag quickcheck passed"

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const response = process.env.DEVDIAG_RESPONSE || '{}';
            const result = JSON.parse(response);

            const problems = result.problems || [];
            const critical = problems.filter(p => p.severity === 'critical');
            const warnings = problems.filter(p => p.severity === 'warning');

            const body = `## ðŸ” DevDiag Quickcheck Results

            **Target:** \`${process.env.TARGET_URL}\`
            **Preset:** app

            ### Summary
            - âŒ Critical: ${critical.length}
            - âš ï¸ Warnings: ${warnings.length}
            - âœ… Info: ${problems.length - critical.length - warnings.length}

            ${critical.length > 0 ? '### Critical Issues\n' + critical.map(p => `- **${p.code}**: ${p.message}`).join('\n') : ''}
            ${warnings.length > 0 ? '### Warnings\n' + warnings.map(p => `- **${p.code}**: ${p.message}`).join('\n') : ''}

            <details>
            <summary>Full Report</summary>

            \`\`\`json
            ${JSON.stringify(result, null, 2)}
            \`\`\`
            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
