name: CSP Baseline Update (Manual)
on:
  workflow_dispatch:
    inputs:
      url:
        description: URL to read CSP header from
        required: true
        default: https://app.ledger-mind.org

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute live CSP hash and write .csp.sha
        shell: pwsh
        run: |
          $Url = "${{ inputs.url }}"
          $hdrs = & pwsh -NoProfile -Command "`n            function Get-LastHeaderMap([string]`$u){`n              `$tmp=[System.IO.Path]::GetTempFileName();`n              try{`$raw = & curl.exe --ssl-no-revoke -sSL -D - -o `$tmp `$u 2>`$null;`n                `$blocks = `$raw -split '(`r?`n){2,}(?=HTTP/)' ; if(`$blocks.Count -gt 1){`$raw=`$blocks[-1]} ;`n                `$h=@{} ; foreach(`$line in (`$raw -split '`r?`n')){ if(`$line -match '^(?<n>[^:]+):\s*(?<v>.*)$'){ `$h[`$matches.n.ToLowerInvariant()]=`$matches.v }} ;`n                return `$h } finally { Remove-Item -Force `$tmp -ErrorAction SilentlyContinue } } ;`n            `$h=Get-LastHeaderMap '$Url' ;`n            `$p=`$h['content-security-policy'] ;`n            if(-not `$p){ throw 'No CSP header live' } ;`n            `$sha=[System.Security.Cryptography.SHA256]::Create();`n            `$hash=(`$sha.ComputeHash([Text.Encoding]::UTF8.GetBytes(`$p))|%%{`$_.ToString('x2')}) -join '' ;`n            `$hash"`
          Set-Content -NoNewline -Path .csp.sha -Value $hdrs

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(csp): update baseline hash"
          title: "chore(csp): update .csp.sha (manual)"
          body: "Manual update of CSP baseline from ${{ inputs.url }}."
          labels: csp-update
          branch: chore/csp-baseline-manual-${{ github.run_id }}
          delete-branch: true
