# Postmortem â€” Tunnel not connected (HTTP code 000)
**Service:** Cloudflared tunnel â†’ Nginx â†’ Backend
**Date:** 2025-09-30 (America/New_York)
**Severity:** S2 (external access degraded)
**Detect:** `edge-verify` reported all external probes as `000` (no connection)

## Summary
External health probes failed (HTTP 000) because the Cloudflare tunnel was not connected to origin. Local stack remained healthy; the issue was at the edge layer. We introduced strict verification and bootstrap tooling to make this class of failure detectable and quickly recoverable.

## Impact
- Public endpoints (/_up, /ready, /api/healthz) unreachable via domain.
- Internal services healthy; no data loss; KMS and migrations OK.

## Timeline
- T0 â€” Deploy prod stack; tunnel status unclear; external probes `000`.
- T0+? â€” Verified local `/api/healthz` OK via nginx.
- T0+? â€” Implemented `edge-verify` strict mode, DNS checks, HA metrics parsing.
- T0+? â€” Added `tunnel-bootstrap` and README recovery steps.
- T0+? â€” Pending: run `make tunnel-verify` post-fixes to confirm recovery.

> Note: exact timestamps to be filled from `docker compose logs cloudflared` and CI logs.

## Root Cause
**Primary (suspected):** credential/config mismatch or DNS mapping absent for the tunnel UUID, resulting in no established HA connections and edge returning 000.
**Contributing factors:** lack of strict pre-flight check on DNS A records and HA connection count before declaring edge healthy.

## What Went Well
- Local stack health clear (KMS, DB, migrations) made isolation fast.
- New tooling (`edge-verify -TunnelStrict -MinHaConnections 1`) provides machine-readable gating.
- `tunnel-bootstrap` standardizes config + credential verification.

## What Went Wrong
- No CI or pre-deploy gate enforcing tunnel/DNS health.
- Earlier docs didnâ€™t mandate matching `<UUID>.json` â†” `config.yml` tunnel ID.
- No cert-expiry signal in edge verify (now proposed).

## Remediation & Action Items
- âœ… Add `make tunnel-verify` to release checklist.
- âœ… Add `tunnel-bootstrap` to first-time/rotate flows.
- ðŸ”œ Add CI job `edge-health.yml` (strict gate, JSON artifact).
- ðŸ”œ Add cert-expiry check (fail if < 14 days remaining).
- ðŸ”œ Optional: `-Retry` backoff in `edge-verify` during cold starts.

## Prevention
- Treat edge connectivity as a **required gate**: DNS A records present, HA connections â‰¥ `MinHaConnections`, and cert days-remaining â‰¥ threshold.
- Keep credentials filename and `config.yml` tunnel UUID in lockstep via `tunnel-bootstrap`.

## Evidence (attach)
- `edge-verify.json` (before/after)
- `cloudflared` last 120 log lines
- DNS records screenshot (Cloudflare)
- `config.yml` excerpt with tunnel UUID
