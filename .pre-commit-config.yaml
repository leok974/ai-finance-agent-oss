repos:
  - repo: https://github.com/psf/black
    rev: 25.9.0
    hooks:
      - id: black
        language_version: python3.11
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.14.3
    hooks:
      - id: ruff
        args: [--fix]
  - repo: local
    hooks:
      - id: docker-compose-config
        name: docker compose config lint
        entry: python scripts/precommit/check_compose.py
        language: python
        files: ^docker-compose.*\.ya?ml$
      - id: forbid-secret-artifacts
        name: block wrapped key exports and service accounts
        entry: python scripts/precommit/block_secret_files.py
        language: python
        stages: [pre-commit]
      - id: block-service-account-json
        name: Block service account JSON files
        entry: bash -c 'if git diff --cached --name-only | grep -Ei "(service[-_ ]?account|gcp).*\.json"; then echo "Blocked service account JSON path"; exit 1; fi'
        language: system
        pass_filenames: false
      - id: grafana-dashboard-validate
        name: Validate Grafana ML dashboard ($prom + required queries)
        language: python
        additional_dependencies: []
        entry: python scripts/validate_grafana_dashboard.py
        files: ^(ops/grafana/|.*ml_suggestions_dashboard\.json$)
      - id: help-panels-why
        name: Help Panels Why Validator
        entry: python scripts/validate_help_panels.py
        language: system
        pass_filenames: false
        stages: [pre-commit]
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-json
      - id: end-of-file-fixer
      - id: trailing-whitespace
  # JSON formatting handled by check-json hook above
  - repo: https://github.com/zricethezav/gitleaks
    rev: v8.29.0
    hooks:
      - id: gitleaks
        args: ["detect", "--no-banner", "--verbose", "--redact", "--config=.gitleaks.toml"]
        pass_filenames: false
  # detect-secrets for additional secret detection
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args: ["--baseline", ".secrets.baseline"]
        additional_dependencies: ["pyyaml"]

# Skip heavy or generated files for faster commits
exclude: >
  (?x)^(
    node_modules/.*|
    dist/.*|
    build/.*|
    \.venv/.*|
    \.venv-bigquery/.*|
    assets/.*|
    .*\.min\.js$|
    .*\.lock$|
    pnpm-lock\.yaml$|
    package-lock\.json$|
    ops/grafana/_exported/.*|
    docs/_site/.*|
    warehouse/target/.*|
    warehouse/logs/.*|
    warehouse/dbt_packages/.*|
    \.pnpm-store/.*|
    apps/web/test-results/.*|
    apps/web/playwright-report/.*|
    \.cache/.*|
    __pycache__/.*|
    .*\.pyc$|
    .*\.pyo$|
    \.pytest_cache/.*|
    \.mypy_cache/.*|
    \.ruff_cache/.*|
    playwright-report/.*|
    .*edge-new-noauth\.json$
  )$
