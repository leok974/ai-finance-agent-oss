# =============================================================================
# AI / COPILOT GUARDRAIL — LEDGERMIND NGINX (PROD)
#
# This nginx sits *behind* Cloudflare Tunnel on HTTP (port 80).
# Cloudflare terminates TLS and may already enforce HTTPS.
#
# IF YOU ARE AN AI ASSISTANT (COPILOT / CHATGPT / ETC), FOLLOW THESE RULES:
#
# 1) DO NOT ADD "HTTP → HTTPS" REDIRECTS HERE.
#    - Do NOT redirect based on $scheme or $http_x_forwarded_proto.
#    - Cloudflare already handles HTTPS; extra redirects can create infinite loops.
#
# 2) PRESERVE THE CANONICAL HOST REDIRECT EXACTLY:
#       ledger-mind.org, www.ledger-mind.org → https://app.ledger-mind.org$request_uri
#    - Do NOT change the target host.
#    - Do NOT change the condition to include app.ledger-mind.org.
#    - Requests with Host "app.ledger-mind.org" MUST NOT be redirected.
#
# 3) NEVER REDIRECT OR REWRITE THESE PATHS:
#       /health
#       /ready
#       /api/metrics
#       /api/e2e/*
#    - These must proxy directly to the backend with the same path.
#
# 4) DO NOT CHANGE UPSTREAM NAMES LIGHTLY.
#    - proxy_pass targets (e.g. http://backend, http://nginx) are relied on by
#      cloudflared and docker-compose. Renaming requires coordinated changes.
#
# 5) IF YOU TOUCH ANY "return 30x" OR "rewrite" DIRECTIVES:
#    - You MUST keep the canonical host redirect logic intact.
#    - You MUST run the verification commands below.
#
# VERIFICATION COMMANDS (RUN AFTER EDITS):
#   # Rebuild + restart nginx
#   docker compose -f docker-compose.prod.yml build --no-cache nginx && \
#   docker compose -f docker-compose.prod.yml up -d nginx
#
#   # Check root does NOT redirect in a loop
#   curl -v https://app.ledger-mind.org/ --max-redirs 5 2>&1 | \
#     sed -n '1,20p'
#
#   # Check E2E session endpoint is reachable and not redirected
#   curl -v -X POST https://app.ledger-mind.org/api/e2e/session \
#     -H "Content-Type: application/json" \
#     -d '{"email":"test@example.com"}' 2>&1 | sed -n '1,20p'
#
# If any of these show repeated 30x redirects to the same URL, REVERT your changes.
# =============================================================================

events {}

http {
    # Map shim header to simple tag for JSON logging
    map $sent_http_x_api_shim $api_shim_tag { default "-"; "rules" "rules"; }

    # Temp paths & body size (50MB for CSV uploads)
    client_max_body_size 50m;
    client_body_temp_path /var/cache/nginx/client_temp 1 2;
    proxy_temp_path       /var/cache/nginx/proxy_temp 1 2;

    # JSON access log format including shim indicator
    log_format main_json escape=json '{"time":"$time_iso8601","remote_addr":"$remote_addr","method":"$request_method","path":"$request_uri","status":$status,"shim":"$api_shim_tag","upstream_status":"$upstream_status","request_time":$request_time}';

    # Extended log format with upstream details for debugging
    log_format main_ext '$remote_addr "$request" $status uri="$uri" req="$request_uri" '
                        'upstream="$upstream_addr" us="$upstream_status" rt="$request_time" urt="$upstream_response_time"';

    # Standard MIME types (ensures .js served as application/javascript etc.)
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;  # removed custom types block (avoided duplicates)
    log_format main '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent ' \
                                    'rt=$request_time urt=$upstream_response_time ua="$http_user_agent"';
    # Active log format (main_json=compact, main_ext=verbose with upstream details)
    access_log /var/cache/nginx/access.log main_ext;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    keepalive_timeout 65s;
    server_tokens off;

    # Compression (only for text-based content)
    gzip on;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/javascript application/json application/xml+rss image/svg+xml;
    gzip_min_length 512;

    # Security headers (edge-level; web container stays minimal)
    map $http_upgrade $upgrade_header { default upgrade; '' close; }
    # Unified Upgrade/Connection mapping for WebSockets & SSE
    map $http_upgrade $connection_upgrade { default upgrade; '' close; }

    # Docker embedded DNS for dynamic container IP resolution
    resolver 127.0.0.11 valid=30s ipv6=off;
        resolver_timeout 5s;

    # Named upstream for ai-finance-backend (only this backend, not generic)
    upstream ai_finance_backend {
        server ai-finance-backend:8000;
        keepalive 64;  # ✅ Increased from 32 to reduce connection overhead
    }

    # Indirection variables allow nginx to start even if name not yet resolvable at master process init
    map $host $backend_upstream { default ai-finance-backend:8000; }
    map $host $agui_upstream { default agui:3030; }
    # Cloudflared metrics upstream (Docker service exposes 0.0.0.0:2000)
    map $host $cloudflared_upstream { default cloudflared:2000; }

    # Auth rate limits tuned per endpoint to soften bursts while avoiding abuse
    limit_req_zone $binary_remote_addr zone=auth_login:10m   rate=30r/m;
    limit_req_zone $binary_remote_addr zone=auth_register:10m rate=10r/m;
    limit_req_zone $binary_remote_addr zone=auth_refresh:10m  rate=240r/m;
    limit_req_status   429;
    limit_req_log_level warn;

    server {
        listen 80;
        # Dynamic DNS resolution tweak: ensure we re-resolve backend service periodically (Docker embedded DNS)
        resolver 127.0.0.11 ipv6=off valid=10s;
        resolver_timeout 5s;  # Ensure resolver timeout is set

        # --------------------------------------------------------------------------------
        # CANONICAL HOST REDIRECT (ledger-mind.org -> app.ledger-mind.org)
        #
        # IMPORTANT:
        # - Cloudflare terminates TLS and forwards HTTP to nginx.
        # - Cloudflare tunnel MUST NOT override Host header (no httpHostHeader hacks).
        # - All host canonicalization lives here, not in cloudflared.
        #
        # If you touch this, re-run:
        #   pwsh scripts/lm-health.ps1   (see repo)
        # --------------------------------------------------------------------------------
        if ($host ~* ^(ledger-mind\.org|www\.ledger-mind\.org)$) {
            return 308 https://app.ledger-mind.org$request_uri;
        }

        # NOTE: NO HTTP→HTTPS redirect here!
        # Cloudflare Tunnel terminates HTTPS and forwards HTTP to nginx.
        # All requests on port 80 are already HTTPS from client perspective.

        # --- Global security headers --------------------------------------------------
        # Centralized security & CSP headers (single source of truth)
        # Use runtime config where CSP hashes are injected by entrypoint script
        include /var/run/nginx-runtime/conf.d/security-headers.conf;
        add_header X-XSS-Protection "0" always;  # legacy header intentionally disabled
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
        # add_header Strict-Transport-Security "max-age=15552000; includeSubDomains; preload" always;  # enable in prod TLS only
        # Temporary debug header to track location matching
        add_header X-Server-Level "yes" always;
        # Global CSP reporting group definition (mirrors per-HTML additions; centralizes for API responses too)
        add_header Report-To '{"group":"csp","max_age":10886400,"endpoints":[{"url":"https://app.ledger-mind.org/api/csp-report"}]}' always;
        # Modern reporting endpoint (fallback for emerging user agents supporting Reporting-Endpoints); relative path safe behind same-origin
        add_header Reporting-Endpoints "csp=\"/api/csp-report\"" always;
        # Build-stamped config version (replaced during render)
        add_header X-Config-Version "__CONFIG_VERSION__" always;

        # ═══════════════════════════════════════════════════════════════════════════════
        # DO NOT REMOVE: X-NGX-Loc headers are REQUIRED for:
        #   1. On-edge routing diagnostics (curl -I <url> | grep x-ngx-loc)
        #   2. CI contract checks (nginx-guards.yml workflow)
        #   3. Production debugging without SSH access
        #
        # These headers identify which nginx location block handled the request,
        # making routing regressions immediately visible in HTTP responses.
        # ═══════════════════════════════════════════════════════════════════════════════

        # ── Exact matches for legacy auth endpoints (highest priority) ──
        location = /api/auth/me {
            add_header X-NGX-Loc "auth-me-exact" always;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;

            rewrite ^ /auth/me break;

            proxy_pass http://ai_finance_backend;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-Id      $request_id;
            proxy_set_header Cookie            $http_cookie;
            proxy_pass_header Set-Cookie;
        }

        # ── Specific Google OAuth pass-through (no rewrite) ──
        location ^~ /api/auth/google/ {
            add_header X-NGX-Loc "google-prefix" always;

            # --- OAuth response header can be big (PKCE/state cookies) ---
            proxy_buffering on;
            proxy_buffers           16 16k;
            proxy_buffer_size       16k;
            proxy_busy_buffers_size 64k;
            proxy_read_timeout 60s;

            proxy_pass http://ai_finance_backend;  # NO trailing slash - preserve full path
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-Id      $request_id;
            proxy_set_header Cookie            $http_cookie;
            proxy_pass_header Set-Cookie;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;
        }

        # ── 3) Legacy endpoints (login/register/refresh/me) — NARROW regex rewrite ──
        location ~ ^/api/auth/(login|register|refresh|me)(/.*)?$ {
            add_header X-NGX-Loc "auth-leaf-rewrite" always;
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET,POST,OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
                add_header Access-Control-Max-Age 86400 always;
                return 204;
            }
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;

            # Rewrite to legacy /auth/* paths
            rewrite ^/api/auth/(.*)$ /auth/$1 break;

            proxy_pass http://ai_finance_backend;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Request-Id      $request_id;
            proxy_set_header Connection "";
            proxy_connect_timeout 3s;
            proxy_read_timeout 30s;
            proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;

            # Apply rate limits (note: limit_req doesn't work inside if, so applied here)
            limit_req zone=auth_login burst=30 nodelay;  # will apply to all, tune if needed
        }

        # ---- Legacy endpoints (compat / deprecation stubs) ----
        # (suggestions persistent stub removed to allow dynamic suggestions endpoint)
        location ^~ /api/insights/ {
            add_header X-Compat-Note "insights removed" always;
            return 204;
        }
        # ---- end legacy stubs ----

        # Auth endpoints proxy directly to backend (no redirect needed)
        location ^~ /auth/ {
            add_header X-NGX-Loc "auth-direct" always;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;

            proxy_pass http://ai_finance_backend;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-Id      $request_id;
            proxy_set_header Cookie            $http_cookie;
            proxy_pass_header Set-Cookie;
        }

        # Demo endpoints proxy directly to backend (similar to auth)
        location ^~ /demo/ {
            add_header X-NGX-Loc "demo-direct" always;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;

            proxy_pass http://ai_finance_backend;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-Id      $request_id;
            proxy_set_header Cookie            $http_cookie;
            proxy_pass_header Set-Cookie;
        }

        # --- Exact API health endpoints (map /api/* to root health paths) ---------------
        # We explicitly map /api/healthz -> /healthz (backend only exposes root path)
        # and /api/ready -> /ready while leaving other /api/* routes untouched below.
        # Host header forced to backend for safer allowlist matching when internal curls omit Host.
        # Boring, fully-normalized health endpoints to satisfy Cloudflared
        # /api/healthz: disable compression & chunking, force identity encoding, buffered
        location = /api/healthz {
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            gzip off;
            chunked_transfer_encoding off;
            proxy_set_header Accept-Encoding identity;
            proxy_buffering on;
            proxy_request_buffering on;
            proxy_read_timeout 10s;
            proxy_pass http://$backend_upstream/healthz;
        }


        # Ready endpoint stays normalized but allows normal identity content
        location = /api/ready {
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering on;
            proxy_request_buffering on;
            proxy_read_timeout 30s;
                proxy_connect_timeout 3s;
                proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
            proxy_pass http://$backend_upstream/ready;
        }

        # Back-compat metrics mapping (temporary). Prefer direct /metrics
        location = /api/metrics { return 307 /metrics; }

        # --- Compat aliases to quiet legacy probes (remove after 2025-12-31) ---
        # Old status → new canonical JSON health
        location = /api/status {
            add_header X-Compat-Alias "api_status_to_api_healthz" always;
            return 307 /api/healthz;
        }
        # Old LLM health under /api → canonical healthz (adjust if /llm/health added later)
        location = /api/llm/health {
            add_header X-Compat-Alias "api_llm_health_to_api_healthz" always;
            return 307 /api/healthz;
        }

        # Back-compat liveness mappings (frontend or probes hitting /api/live or /api/_up)
        location = /api/live {
            proxy_http_version 1.1;
            proxy_set_header Host backend;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
            proxy_buffering off;
            proxy_pass http://$backend_upstream/live;
                proxy_connect_timeout 3s;
                proxy_read_timeout 30s;
                proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        }

        location = /api/_up { return 204; access_log off; }

        # (Removed obsolete /api/(charts|rules|suggestions) shim & underscore rewrites; frontend now calls root paths)


        # Path compatibility: /api/agent/* → /agent/* (for legacy E2E tests)
        location ^~ /api/agent/ {
            add_header X-NGX-Loc "api-agent-compat" always;
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, x-test-mode, X-Client-Id, X-Timestamp, X-Signature" always;
                add_header Access-Control-Max-Age 86400 always;
                return 204;
            }
            # Rewrite /api/agent/* → /agent/*
            rewrite ^/api/agent/(.*)$ /agent/$1 break;

            proxy_hide_header Content-Security-Policy;
            proxy_pass http://ai_finance_backend;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Port  443;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Request-Id      $request_id;
            # HMAC auth headers pass-through
            proxy_set_header X-Client-Id       $http_x_client_id;
            proxy_set_header X-Timestamp       $http_x_timestamp;
            proxy_set_header X-Signature       $http_x_signature;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_pass_header X-LLM-Path;
        }

        # E2E test session endpoint (explicit location for debugging)
        location /api/e2e/ {
            add_header X-NGX-Loc "api_e2e" always;
            add_header X-Debug-Scheme "$scheme" always;
            add_header X-Debug-XFP "$http_x_forwarded_proto" always;

            proxy_pass http://ai-finance-backend:8000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }

        # General API endpoints
        # ── 4) Generic /api/* — no rewrites, no prefix stripping ──
        location ^~ /api/ {
            add_header X-NGX-Loc "api-catchall" always;
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $http_origin always;
                add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
                add_header Access-Control-Max-Age 86400 always;
                return 204;
            }
            # Hide backend CSP to use nginx's runtime-generated CSP instead
            proxy_hide_header Content-Security-Policy;
            proxy_pass http://ai_finance_backend;  # NO trailing slash - preserve full path
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto https;  # Force HTTPS for OAuth redirects
            proxy_set_header X-Forwarded-Port  443;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Request-Id      $request_id;
            proxy_redirect off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
            proxy_buffering off;
            proxy_pass_header X-LLM-Path;
        }

        # Modern root (non-/api) analytics & other agent endpoints
        location ^~ /agent/ {
            # Hide backend CSP to use nginx's runtime-generated CSP instead
            proxy_hide_header Content-Security-Policy;
            proxy_pass http://$backend_upstream;
            proxy_set_header Host               $host;
            proxy_set_header X-Forwarded-Host   $host;
            proxy_set_header X-Forwarded-Proto  $scheme;
            proxy_set_header X-Forwarded-Port   $server_port;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            # HMAC auth headers pass-through
            proxy_set_header X-Client-Id        $http_x_client_id;
            proxy_set_header X-Timestamp        $http_x_timestamp;
            proxy_set_header X-Signature        $http_x_signature;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;
            proxy_request_buffering off;
            add_header X-Accel-Buffering "no" always;
            proxy_connect_timeout   5s;
            proxy_send_timeout      75s;  # ✅ Increased for E2E load
            proxy_read_timeout      75s;  # ✅ Increased for E2E load
            proxy_next_upstream     error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 3;
        }

        # Ingest endpoint - large file uploads with extended timeout
        location ^~ /ingest {
            client_max_body_size   50m;

            # Ensure upstream sees Content-Length (not chunked)
            proxy_request_buffering on;              # buffer first, compute Content-Length
            proxy_set_header      Content-Length $content_length;
            proxy_set_header      Transfer-Encoding "";   # strip TE header if present

            proxy_read_timeout      300s;
            proxy_send_timeout      300s;

            # Pass straight to FastAPI service
            proxy_pass http://backend:8000;

            # Standard forward headers
            proxy_http_version 1.1;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
            proxy_set_header Authorization      $http_authorization;
            # CRITICAL: Forward cookies for auth and CSRF
            proxy_set_header Cookie             $http_cookie;
            proxy_pass_header Set-Cookie;
            # CRITICAL: Forward CSRF token header
            proxy_set_header X-CSRF-Token       $http_x_csrf_token;

            # Avoid caching uploads
            add_header Cache-Control "no-store" always;
        }

    # Legacy /api/agent/* and /api/ingest/* rewrites removed —
    # old bundles must be updated to call canonical /agent/* paths.

        # Health & version
        location = /_up { return 204; access_log off; }
        location = /_version {
            # Serve the baked version.json directly via alias
            default_type application/json;
            alias /usr/share/nginx/html/version.json;
            add_header Cache-Control "no-store";
        }
        # Backend dynamic version endpoint (build metadata)
        location = /version {
            proxy_pass http://$backend_upstream/version;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # Prometheus / fallback metrics exposition (text/plain). Without this block, /metrics was
        # falling through to SPA fallback and serving index.html. This forwards directly to backend
        # instrumentation (either prometheus_fastapi_instrumentator or fallback router).
        location = /metrics {
            proxy_pass http://$backend_upstream/metrics;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # Cloudflared exporter passthrough: expose tunnel metrics via nginx for unified scraping
        location = /cf/metrics {
            proxy_pass http://$cloudflared_upstream/metrics;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            add_header Cache-Control "no-store" always;
        }

        # Additional backend paths (outside canonical /api/ prefix) – kept for backward compatibility
        # NOTE: ingest removed - has dedicated location block with Cookie forwarding
    location ~* ^/(agent|llm|analytics|charts|txns|transactions|unknowns|overview|summary|expanded|merchants|spending_trends|dashboard|models|rules|ml|stats|report|docs|openapi\.json|healthz|ready|metrics|alerts) {
            proxy_pass http://$backend_upstream$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_pass_header X-LLM-Path;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            # CRITICAL: Forward cookies for auth and CSRF
            proxy_set_header Cookie             $http_cookie;
            proxy_pass_header Set-Cookie;
            # CRITICAL: Forward CSRF token header
            proxy_set_header X-CSRF-Token       $http_x_csrf_token;
        }

        # AG UI SSE stream
        location ^~ /agui/ {
            proxy_pass http://$agui_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_buffering off;
            add_header X-Accel-Buffering no;
        }

        # Static assets (fingerprinted). Single consolidated matcher avoids fallback collisions.
        # Hashed assets can be cached forever (immutable = never revalidate)
        location ^~ /assets/ {
            root /usr/share/nginx/html;
            try_files $uri =404;
            access_log off;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable" always;
        }

        # Explicit JS / MJS safeguard outside /assets if any top-level bundles emitted
        location ~* ^/.+\.(?:m?js)$ {
            root /usr/share/nginx/html;
            try_files $uri =404;
            access_log off;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";
            default_type application/javascript;
        }

        # Common static (fonts/images/etc.) at root (favicon, icons)
        location ~* ^/.+\.(?:css|map|woff2?|ttf|svg|png|jpg|jpeg|gif|webp|ico)$ {
            root /usr/share/nginx/html;
            try_files $uri =404;
            access_log off;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # Web App Manifest with correct MIME & modest cache
        location = /site.webmanifest {
            root /usr/share/nginx/html;
            try_files $uri =404;
            default_type application/manifest+json;
            add_header Content-Type application/manifest+json;
            expires 1h;
            add_header Cache-Control "public, max-age=3600";
        }

        # Build metadata (web) – always no-store so tests see current deployed image
        location = /build.json {
            root /usr/share/nginx/html;
            try_files $uri =404;
            default_type application/json;
            add_header Content-Type application/json;
            add_header Cache-Control "no-store, must-revalidate";
        }

        # WASM (if any emitted outside /assets)
        location ~* ^/.+\.wasm$ {
            root /usr/share/nginx/html;
            try_files $uri =404;
            access_log off;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";
            default_type application/wasm;
        }

        # Explicit index.html (avoid caching + ensure no SPA fallback recursion)
        # MUST NEVER BE CACHED - prevents old shell + new JS mismatch (React #185 hydration errors)
        location = /index.html {
            root /usr/share/nginx/html;
            try_files $uri =404;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;
            expires -1;
            # CSP must be included here because add_header doesn't inherit when location has its own add_header
            include /var/run/nginx-runtime/conf.d/security-headers.conf;
        }

        # SPA fallback
        # --- Unified Help endpoint passthroughs (exact paths) ------------------
        # Direct /help for existing frontend fetch('/help') usage
        location = /help {
            proxy_pass http://$backend_upstream/help;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_pass_header X-LLM-Path;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
        # Future-safe alias under canonical /api prefix
        location = /api/help {
            proxy_pass http://$backend_upstream/help;
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_pass_header X-LLM-Path;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # Chat iframe SPA - Allow same-origin framing
        location /chat/ {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /chat/index.html;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;
            # Override X-Frame-Options to allow same-origin framing (critical for iframe)
            add_header X-Frame-Options "SAMEORIGIN" always;
            # Override CSP frame-ancestors to allow same-origin (chat can be framed by main app)
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://lh3.googleusercontent.com https://*.googleusercontent.com; font-src 'self' data:; connect-src 'self' https: wss:; media-src 'none'; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'" always;
        }

        # SPA fallback: serve static file when path not found; only HTML falls back
        location / {
            root /usr/share/nginx/html;
            try_files $uri /index.html;
            add_header Cache-Control "no-store" always;
            # CSP must be included here because add_header doesn't inherit when location has its own add_header
            include /var/run/nginx-runtime/conf.d/security-headers.conf;
        }

        # Legacy selective per-HTML headers were consolidated into global block above.
    }
}
