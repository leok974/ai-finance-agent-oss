server {
  listen 80;
  server_name ledger-mind.org app.ledger-mind.org;

  # allow CSV uploads (tune as needed)
  client_max_body_size 50m;
  proxy_request_buffering off;

  # Cookie policy: keep Secure/HttpOnly; use Lax to avoid strict cross-site issues
  proxy_cookie_flags access_token  Secure HttpOnly SameSite=Lax;
  proxy_cookie_flags refresh_token Secure HttpOnly SameSite=Lax;
  proxy_cookie_flags csrf_token    Secure SameSite=Lax;
  # Ensure cookies apply to the root path
  proxy_cookie_path / /;

  # Static SPA
  root /usr/share/nginx/html;
  index index.html;

  # Health check (proxy to backend)
  location = /ready {
    if ($request_method = HEAD) { return 200; }
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://backend:8000/ready;
  }

  # Healthz endpoint
  location = /healthz {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://backend:8000/healthz;
  }

  # CSV ingest (POST)
  location = /ingest {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_pass http://backend:8000/ingest;
  }

  # Note: `/uncategorized` is a SPA route â€” do not proxy it

  # AUTH must hit backend (fixes 405 on refresh)
  location ^~ /auth {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Authorization $http_authorization;
    proxy_pass http://backend:8000;
  }

  # Catch API-ish prefixes so they don't fall into the SPA
  location ~ ^/(auth|charts|txns|transactions|unknowns|overview|summary|expanded|merchants|spending_trends|dashboard|models|rules|ml|stats|agent|report|docs|openapi\.json)(/|$) {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Authorization $http_authorization;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    add_header Cache-Control "no-store" always;
    proxy_pass http://backend:8000;
  }

  # /agui/* -> Elysia gateway (SSE friendly)
  location /agui/ {
    proxy_pass http://agui:3030;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header Connection '';
    proxy_buffering off;
    add_header X-Accel-Buffering no;
  }

  # SPA fallback with strict CSP (SSE-friendly)
  location / {
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' https: wss:; media-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'" always;
    try_files $uri /index.html;
  }
}
